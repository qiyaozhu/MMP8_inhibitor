<root
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
xsi:noNamespaceSchemaLocation="rosetta.xsd"
/>

<ROSETTASCRIPTS>
	<SCOREFXNS>
		# The current Rosetta default scorefunction.
		<ScoreFunction name="ref" weights="ref2015" />
		# The default scorefunction with increased hydrogen bond weights, aa_composition, aspartimide_penalty, and constraints.
		<ScoreFunction name="ref_highhbond" weights="ref2015" >
			<Reweight scoretype="hbond_lr_bb" weight="10.0" />
			<Reweight scoretype="hbond_sr_bb" weight="10.0" />
			<Reweight scoretype="aa_composition" weight="1.0" />
			<Reweight scoretype="aspartimide_penalty" weight="1.0" />
			<Reweight scoretype="chainbreak" weight="25.0" />
			<Reweight scoretype="voids_penalty" weight="0.1" />
			<Reweight scoretype="buried_unsatisfied_penalty" weight="1.0" />
		</ScoreFunction>
	</SCOREFXNS>

	# The PACKER_PALETTES section defines the total set of residues with which we're designing.
	<PACKER_PALETTES>
		<CustomBaseTypePackerPalette name="palette" additional_residue_types="DALA,DASP,DGLU,DPHE,DHIS,DILE,DLYS,DLEU,DMET,DASN,DPRO,DGLN,DARG,DSER,DTHR,DVAL,DTRP,DTYR" /> 
	</PACKER_PALETTES>

	# The RESIDUE_SELECTORS section allows users to configure tools to select residues,
	# which are used when setting up other Rosetta modules.
	<RESIDUE_SELECTORS>
		# Select residues with mainchain phi torsion values greater than zero.
		# These positions will be restricted to becoming D-amino acids during design.
		<Phi name="posPhi" select_positive_phi="true" />
		# Select residues with mainchain phi torsion values less than zero.
		# These positions will be restricted to becoming L-amino acids during design.
		<Phi name="negPhi" select_positive_phi="false" />
		# Select the most buried residues.
    	<Layer name="select_core" select_core="true" select_boundary="false" select_surface="false" core_cutoff="2.5" surface_cutoff="1.0" />
    	# Select partially buried residues.
    	<Layer name="select_boundary" select_core="false" select_boundary="true" select_surface="false" core_cutoff="2.5" surface_cutoff="1.0" />
    	# Select fully solvent-exposed residues.
    	<Layer name="select_surface" select_core="false" select_boundary="false" select_surface="true" core_cutoff="2.5" surface_cutoff="1.0" />
		# Select MMP8 and peptide residues.
		<Index name="select_MMP8" resnums="1-161" />
		<Index name="select_stubs" resnums="170-171" />
		<Not name="select_peptide" selector="select_MMP8" />
		<Neighborhood name="select_near_peptide" selector="select_peptide" distance="8.0"  include_focus_in_subset="false" />
		<Index name="select_lower_cutpoint_pep" resnums="%%lower_cut_point%%" />
		<Index name="select_upper_cutpoint_pep" resnums="%%upper_cut_point%%" />
		# Retrieve the original select_near_peptide residue subset created by the "StoreResidueSubset" mover
		<StoredResidueSubset name="get_original_near_peptide" subset_name="subset_near_peptide" />
		# Prevent repacking MMP8 residues that are not close to the peptide
		<Logic name="select_prevent_repack" selector="select_MMP8 and (not get_original_near_peptide)" />	
		# Restrict to repacking stubs and peptide-neighborhood MMP8 residues
		<Logic name="select_restrict_repack" selector="select_stubs or get_original_near_peptide" />
	</RESIDUE_SELECTORS>

	# The FILTERS section allows users to configure filters.
	<FILTERS>
		# Filter to avoid score function artifact of having more than two hydrogen bonds to carbonyls.
		<OversaturatedHbondAcceptorFilter name="oversat" scorefxn="ref" max_allowed_oversaturated="0" consider_mainchain_only="false"/>
		# Filter to ensure a minimum number of hbonds in the peptide.
		<PeptideInternalHbondsFilter name="min_internal_hbonds" residue_selector="select_peptide" hbond_cutoff="6" />
	</FILTERS>

	# The TASKOPERATIONS section allows users to configure task operations, which are Rosetta modules that control the
	# behavior of Rosetta's "Packer" module.  The Packer, in turn, is used for side-chain identity and rotamer optimization.
	<TASKOPERATIONS>
		# Task operation to read a resfile defining the D-amino acids for design at positions with positive phi torsions.
		<ReadResfile name="d_res" filename="design_inputs/d_res.txt" selector="posPhi"/>
		# Task operation to read a resfile defining the L-amino acids for design at positions with negative phi torsions.
		<ReadResfile name="l_res" filename="design_inputs/l_res.txt" selector="negPhi"/>
		
		# At buried positions, restrict to PFAMILYVW, and the D-aa equivalents.
    	<RestrictToSpecifiedBaseResidueTypes name="core_restrictions" base_types="PRO,PHE,ALA,MET,ILE,LEU,TYR,VAL,TRP,DPRO,DPHE,DALA,DMET,DILE,DLEU,DTYR,DVAL,DTRP" selector="select_core"/>
    	# At semi-buried positions, restrict to PAILYVNQDERKSTH, and the D-aa equivalents.
    	<RestrictToSpecifiedBaseResidueTypes name="boundary_restrictions" base_types="PRO,ALA,ILE,LEU,TYR,VAL,ASN,GLN,ASP,GLU,ARG,LYS,SER,THR,HIS,DPRO,DALA,DILE,DLEU,DTYR,DVAL,DASN,DGLN,DASP,DGLU,DARG,DLYS,DSER,DTHR,DHIS" selector="select_boundary"/>
    	# At surface-exposed positions, restrict to PANQDERKSTH, and the D-aa equivalents.
    	<RestrictToSpecifiedBaseResidueTypes name="surf_restrictions" base_types="PRO,ALA,ASN,GLN,ASP,GLU,ARG,LYS,SER,THR,HIS,DPRO,DALA,DASN,DGLN,DASP,DGLU,DARG,DLYS,DSER,DTHR,DHIS" selector="select_surface"/>
		
		# Prevent repacking residues (no design, no repack)
		<OperateOnResidueSubset name="prevent_repack" selector="select_prevent_repack">
			<PreventRepackingRLT />
		</OperateOnResidueSubset>
		# Restrict design for stubs and peptide-neighborhood MMP8 residues
		<OperateOnResidueSubset name="restrict_repack" selector="select_restrict_repack">
			<RestrictToRepackingRLT />
		</OperateOnResidueSubset>
	</TASKOPERATIONS>

	# A MoveMap is used to specify which degrees of freedom can move and which are fixed during energy minimization.
	# Here, all mainchain torsions (bb) and sidechain torsions (chi) of the peptide can move.
	<MOVE_MAP_FACTORIES>
		<MoveMapFactory name="fdes_mf" bb="false" chi="false" jumps="true">
			<Backbone residue_selector="select_peptide" enable="true" />
			<Chi residue_selector="select_peptide" enable="true" />
			<Chi residue_selector="get_original_near_peptide" enable="true" />
		</MoveMapFactory>
	</MOVE_MAP_FACTORIES>

	# The MOVERS section allows users to define movers, which are Rosetta modules
	# that modify a structure in some way:
	<MOVERS>
		# A mover to declare a bond connecting the termini, upper cutpoint is with N terminal, lower with C terminal
		<DeclareBond name="peptide_bond1" res1="%%upper_cut_point%%" atom1="N" atom2="C" res2="%%lower_cut_point%%" add_termini="true" />
		# Add two virtual atoms to each cutpoint, virtual CA and C before the upper cutpoint, virtual N and CA after the lower cutpoint
		# Want the virtual atoms to align with the real ones so that cyclization is ideal
		<ModifyVariantType name="pep_cutpoint_upper" residue_selector="select_upper_cutpoint_pep" add_type="CUTPOINT_UPPER" />
        <ModifyVariantType name="pep_cutpoint_lower" residue_selector="select_lower_cutpoint_pep" add_type="CUTPOINT_LOWER" />
		<!-- <CreateTorsionConstraint name="peptide_torsion_constraint">
			<Add res1="%%Nres%%" res2="%%Nres%%" res3="1" res4="1" atom1="CA" atom2="C" atom3="N" atom4="CA" cst_func="CIRCULARHARMONIC 3.141592654 0.005" />
		</CreateTorsionConstraint>
		<CreateAngleConstraint name="peptide_angle_constraints">
			<Add res1="%%Nres%%" atom1="CA" res_center="%%Nres%%" atom_center="C" res2="1" atom2="N" cst_func="CIRCULARHARMONIC 2.02807247 0.005" />
			<Add res1="%%Nres%%" atom1="C" res_center="1" atom_center="N" res2="1" atom2="CA" cst_func="CIRCULARHARMONIC 2.12406565 0.005" />
		</CreateAngleConstraint>
		<CreateDistanceConstraint name="N_To_C_dist_cst">
			<Add res1="%%Nres%%" res2="1" atom1="C" atom2="N" cst_func="HARMONIC 1.32865 0.01" />
		</CreateDistanceConstraint> -->
		<AtomTree name="foldtree" fold_tree_file="design_inputs/foldtree_MMP8.txt" />
		<SetupMetalsMover name="metalfix" />
		# Composition constraints are used with the aa_composition score term to add penalty for deviation from a desired amino acid composition.
		<AddCompositionConstraintMover name="addcompcsts" selector="select_peptide" filename="design_inputs/desired_makeup_MMP8.comp" />
		# Store the MMP8 residue selection close to the peptide to avoid selection changes caused by peptide design
		<StoreResidueSubset name="store_near_peptide" subset_name="subset_near_peptide" residue_selector="select_near_peptide" />
		# Alternating rounds of sequence design and torsion-space energy minimization, while ramping the repulsive energy term.
		# Here, a modified scorefunction with constraints and aa_composition energy terms activated.
		<FastDesign name="fdes" movemap_factory="fdes_mf" scorefxn="ref_highhbond" repeats="3" task_operations="d_res,l_res,core_restrictions,boundary_restrictions,surf_restrictions,prevent_repack,restrict_repack" packer_palette="palette" ramp_down_constraints="false" />
	</MOVERS>

	# The PROTOCOLS section is the section in which the user invokes the modules
	# defined above in linear sequence to define a protocol:
	<PROTOCOLS>
		<Add mover="peptide_bond1" />
		<Add mover="pep_cutpoint_upper" />
		<Add mover="pep_cutpoint_lower" />
		<Add mover="foldtree" />
		<Add mover="metalfix" />
		<Add mover="addcompcsts" />
		<Add mover="store_near_peptide" />
		<Add mover="fdes" />
		# A side-effect of the DeclareBond mover is the correction of positions of H and O atoms that depend on the peptide bond.
		# We re-invoke it here for that purpose.
		<Add mover="peptide_bond1" />
		<Add filter="oversat" />
		<Add filter="min_internal_hbonds" />
	</PROTOCOLS>
	
	# We specify the scoring function that will be used to score the output structure.
	<OUTPUT scorefxn="ref" />
</ROSETTASCRIPTS>
